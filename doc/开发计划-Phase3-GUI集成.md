# Phase 3 开发计划 - GUI集成

**版本**: v0.2.0
**阶段**: Phase 3 - GUI Integration
**预计时间**: 2-3周
**开始时间**: 待定
**状态**: 📋 规划中

---

## 📋 目标

将 Phase 2 开发的所有后端功能集成到 Makepad GUI 中，提供完整的用户界面来管理动态代理链。

---

## 🎯 核心功能

### 1. 上游代理管理界面

**功能描述**:
- 展示所有上游代理列表
- 支持添加/编辑/删除代理
- 支持启用/禁用代理
- 显示代理健康状态
- 显示延迟和错误信息

**UI组件**:
- 代理列表视图 (ListView)
- 添加/编辑对话框 (Modal)
- 健康状态指示器 (Icon + Text)
- 延迟显示 (Label)
- 操作按钮 (Button: 编辑, 删除, 启用/禁用)

### 2. 健康检查控制面板

**功能描述**:
- 显示健康检查配置
- 手动触发健康检查
- 显示最后检查时间
- 显示检查历史
- 配置健康检查参数

**UI组件**:
- 配置面板 (Form)
- 立即检查按钮 (Button)
- 检查历史列表 (ListView)
- 参数配置表单 (Input fields)

### 3. Clash配置监控界面

**功能描述**:
- 显示当前监控的配置文件路径
- 显示监控状态 (运行中/已停止)
- 显示最近的文件变化事件
- 配置监控参数
- 启动/停止监控

**UI组件**:
- 文件路径显示 (Label)
- 监控状态指示器 (Status Icon)
- 事件日志列表 (ListView)
- 启动/停止按钮 (Toggle Button)
- 配置表单 (Input fields)

### 4. 配置合并控制面板

**功能描述**:
- 手动触发配置合并
- 显示合并结果
- 显示备份文件列表
- 配置合并参数
- 恢复备份功能

**UI组件**:
- 合并按钮 (Button)
- 结果显示面板 (Text Area)
- 备份列表 (ListView)
- 恢复按钮 (Button)
- 配置表单 (Input fields)

### 5. Tab切换与主界面整合

**功能描述**:
- 添加新的 "动态代理" Tab
- 与现有的 "Patcher" Tab 共存
- 保持现有功能不变
- 统一的UI风格

**UI组件**:
- Tab Bar (TabView)
- Tab Content Area
- 状态栏 (Status Bar)

---

## 🏗️ 架构设计

### 模块结构

```
src/
├── ui/
│   ├── mod.rs              # UI模块入口
│   ├── app.rs              # 主应用（更新）
│   ├── tabs/
│   │   ├── mod.rs          # Tab管理
│   │   ├── patcher_tab.rs  # 现有Patcher Tab
│   │   └── proxy_tab.rs    # 新的动态代理Tab
│   ├── components/
│   │   ├── mod.rs
│   │   ├── proxy_list.rs   # 代理列表组件
│   │   ├── health_panel.rs # 健康检查面板
│   │   ├── watcher_panel.rs# 监控面板
│   │   └── merger_panel.rs # 合并面板
│   └── widgets/
│       ├── mod.rs
│       ├── proxy_item.rs   # 代理项组件
│       └── status_badge.rs # 状态徽章
├── bridge/
│   ├── mod.rs              # 后端桥接模块
│   ├── config_bridge.rs    # 配置管理桥接
│   ├── health_bridge.rs    # 健康检查桥接
│   ├── watcher_bridge.rs   # 监控桥接
│   └── merger_bridge.rs    # 合并桥接
└── state/
    ├── mod.rs              # 状态管理
    └── proxy_state.rs      # 代理状态
```

### 状态管理

使用 Makepad 的响应式状态管理:

```rust
pub struct ProxyState {
    // 上游代理列表
    pub upstreams: Vec<UpstreamProxy>,

    // 健康检查器
    pub health_checker: Option<Arc<HealthChecker>>,

    // 监控器
    pub watcher: Option<WatcherHandle>,

    // 配置管理器
    pub config_manager: ConfigManager,

    // UI状态
    pub selected_proxy: Option<String>,
    pub is_checking: bool,
    pub is_watching: bool,
}
```

### 后端桥接

创建桥接层，将异步后端操作与同步GUI连接:

```rust
pub struct ConfigBridge {
    runtime: tokio::runtime::Runtime,
    manager: Arc<RwLock<ConfigManager>>,
}

impl ConfigBridge {
    pub fn list_upstreams(&self) -> Vec<UpstreamProxy> {
        self.runtime.block_on(async {
            self.manager.read().await.list_upstreams().to_vec()
        })
    }

    pub fn add_upstream(&self, proxy: UpstreamProxy) -> Result<()> {
        self.runtime.block_on(async {
            self.manager.write().await.add_upstream(proxy)
        })
    }
}
```

---

## 📝 任务分解

### Task 3.1: 基础架构搭建 (3-4天)

**子任务**:
- [ ] 创建 `src/ui/tabs/` 目录结构
- [ ] 创建 `src/bridge/` 桥接模块
- [ ] 创建 `src/state/` 状态管理
- [ ] 实现 ConfigBridge
- [ ] 实现 HealthBridge
- [ ] 实现 WatcherBridge
- [ ] 实现 MergerBridge
- [ ] 更新主 App 结构支持多 Tab
- [ ] 编写基础测试

**依赖**:
- 无新增依赖

**验收标准**:
- ✅ 桥接层可以正确调用后端功能
- ✅ 状态管理正常工作
- ✅ Tab切换功能正常

### Task 3.2: 代理列表界面 (3-4天)

**子任务**:
- [ ] 实现 ProxyListView 组件
- [ ] 实现 ProxyItem 组件
- [ ] 实现添加代理对话框
- [ ] 实现编辑代理对话框
- [ ] 实现删除确认对话框
- [ ] 集成健康状态显示
- [ ] 实现启用/禁用切换
- [ ] 添加刷新按钮
- [ ] 编写UI测试

**UI设计**:
```
┌─────────────────────────────────────────────────────────────┐
│  上游代理管理                                    [+ 添加]    │
├─────────────────────────────────────────────────────────────┤
│  ☑ Hong Kong Proxy          ✅ 健康 (120ms)    [编辑][删除]│
│  ☐ US Proxy                 ❌ 不健康          [编辑][删除]│
│  ☑ Japan Proxy              ⚫ 未知            [编辑][删除]│
└─────────────────────────────────────────────────────────────┘
```

**验收标准**:
- ✅ 可以查看所有代理
- ✅ 可以添加新代理
- ✅ 可以编辑现有代理
- ✅ 可以删除代理
- ✅ 可以启用/禁用代理
- ✅ 健康状态正确显示

### Task 3.3: 健康检查面板 (2-3天)

**子任务**:
- [ ] 实现 HealthPanel 组件
- [ ] 实现立即检查按钮
- [ ] 实现配置参数表单
- [ ] 实现检查历史列表
- [ ] 集成后台健康检查
- [ ] 实现进度指示器
- [ ] 编写UI测试

**UI设计**:
```
┌─────────────────────────────────────────────────────────────┐
│  健康检查                                                    │
├─────────────────────────────────────────────────────────────┤
│  配置:                                                       │
│    超时: [10] 秒    间隔: [300] 秒    失败阈值: [3]        │
│                                               [立即检查]     │
├─────────────────────────────────────────────────────────────┤
│  最近检查:                                                   │
│  • 2026-02-02 12:00:00 - Hong Kong Proxy ✅ 120ms          │
│  • 2026-02-02 12:00:01 - US Proxy ❌ 连接超时               │
└─────────────────────────────────────────────────────────────┘
```

**验收标准**:
- ✅ 可以手动触发健康检查
- ✅ 可以配置检查参数
- ✅ 可以查看检查历史
- ✅ 后台自动检查正常工作

### Task 3.4: 监控面板 (2-3天)

**子任务**:
- [ ] 实现 WatcherPanel 组件
- [ ] 实现文件路径选择器
- [ ] 实现监控启动/停止按钮
- [ ] 实现事件日志列表
- [ ] 实现防抖配置
- [ ] 集成文件监控功能
- [ ] 编写UI测试

**UI设计**:
```
┌─────────────────────────────────────────────────────────────┐
│  Clash配置监控                                               │
├─────────────────────────────────────────────────────────────┤
│  配置文件: ~/.config/clash/config.yaml        [选择文件]   │
│  防抖延迟: [2] 秒                                           │
│                                    [启动监控] / [停止监控]  │
├─────────────────────────────────────────────────────────────┤
│  事件日志:                                                   │
│  • 12:30:15 - 配置文件修改                                  │
│  • 12:25:42 - 配置文件修改                                  │
└─────────────────────────────────────────────────────────────┘
```

**验收标准**:
- ✅ 可以选择配置文件
- ✅ 可以启动/停止监控
- ✅ 可以查看事件日志
- ✅ 防抖功能正常工作

### Task 3.5: 合并面板 (2-3天)

**子任务**:
- [ ] 实现 MergerPanel 组件
- [ ] 实现合并按钮
- [ ] 实现结果显示
- [ ] 实现备份列表
- [ ] 实现恢复功能
- [ ] 实现配置参数表单
- [ ] 编写UI测试

**UI设计**:
```
┌─────────────────────────────────────────────────────────────┐
│  配置合并                                                    │
├─────────────────────────────────────────────────────────────┤
│  代理名称: [Local-Chain-Proxy]                              │
│  监听地址: [127.0.0.1:10808]                                │
│  插入位置: ○ 开头  ● 末尾                                   │
│                                                   [立即合并] │
├─────────────────────────────────────────────────────────────┤
│  最近合并结果:                                               │
│  ✅ 节点已添加, 更新了 5 个代理组                            │
│  📁 备份: config.yaml.backup-20260202-120000                │
└─────────────────────────────────────────────────────────────┘
```

**验收标准**:
- ✅ 可以触发配置合并
- ✅ 可以查看合并结果
- ✅ 可以查看备份列表
- ✅ 可以恢复备份
- ✅ 可以配置合并参数

### Task 3.6: 主界面整合 (2-3天)

**子任务**:
- [ ] 实现 Tab 切换逻辑
- [ ] 更新主 App 结构
- [ ] 集成所有面板组件
- [ ] 实现统一的状态管理
- [ ] 实现错误处理和提示
- [ ] 添加加载指示器
- [ ] 优化UI布局和样式
- [ ] 编写集成测试

**主界面设计**:
```
┌─────────────────────────────────────────────────────────────┐
│  Clash Chain Patcher                              [_][□][×] │
├─────────────────────────────────────────────────────────────┤
│  [Patcher]  [动态代理]                                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─ 上游代理管理 ──────────────────────────────────────┐   │
│  │  ...                                                 │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌─ 健康检查 ───────────────────────────────────────────┐  │
│  │  ...                                                 │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌─ 配置监控 ───────────────────────────────────────────┐  │
│  │  ...                                                 │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
│  就绪                                                        │
└─────────────────────────────────────────────────────────────┘
```

**验收标准**:
- ✅ Tab 切换流畅
- ✅ 所有面板正常工作
- ✅ 状态管理统一
- ✅ 错误提示友好
- ✅ UI响应迅速

### Task 3.7: 测试与优化 (2-3天)

**子任务**:
- [ ] 编写集成测试
- [ ] 进行性能优化
- [ ] 修复发现的bug
- [ ] 优化UI响应速度
- [ ] 优化内存使用
- [ ] 添加用户反馈机制
- [ ] 完善错误处理
- [ ] 更新文档

**验收标准**:
- ✅ 所有测试通过
- ✅ 性能满足要求
- ✅ 无明显bug
- ✅ UI流畅
- ✅ 内存使用合理

---

## 🔧 技术难点

### 1. 异步桥接

**问题**: Makepad GUI 是同步的，而后端功能是异步的
**解决方案**: 使用 tokio runtime 的 `block_on` 在桥接层中同步执行异步代码

### 2. 状态更新

**问题**: 后台任务更新状态时如何通知GUI刷新
**解决方案**: 使用 channels 和定时轮询机制

### 3. 长时间操作

**问题**: 健康检查等操作可能耗时较长，会阻塞UI
**解决方案**: 在后台线程执行，GUI显示进度指示器

### 4. Tab切换

**问题**: Makepad 的 Tab 组件实现可能不够成熟
**解决方案**: 参考 Makepad Studio 的实现，或自定义 Tab 组件

---

## 📊 工作量估算

| 任务 | 预计时间 | 依赖 |
|------|---------|------|
| Task 3.1: 基础架构 | 3-4天 | - |
| Task 3.2: 代理列表 | 3-4天 | Task 3.1 |
| Task 3.3: 健康检查 | 2-3天 | Task 3.1, 3.2 |
| Task 3.4: 监控面板 | 2-3天 | Task 3.1 |
| Task 3.5: 合并面板 | 2-3天 | Task 3.1 |
| Task 3.6: 主界面整合 | 2-3天 | Task 3.1-3.5 |
| Task 3.7: 测试优化 | 2-3天 | Task 3.1-3.6 |
| **总计** | **16-23天 (2-3周)** | - |

---

## 🎨 UI风格指南

### 颜色方案
- 主色调: 与现有 Patcher Tab 保持一致
- 健康状态: 绿色 ✅
- 不健康状态: 红色 ❌
- 未知状态: 灰色 ⚫
- 检查中: 蓝色 🔄

### 字体
- 中文: 使用 makepad-fonts-chinese
- 英文/数字: 系统默认

### 间距
- 组件间距: 8px
- 面板边距: 16px
- 按钮高度: 32px

---

## ✅ 验收标准

### 功能完整性
- [ ] 所有计划功能已实现
- [ ] 所有UI组件正常工作
- [ ] 所有操作有反馈
- [ ] 错误处理完善

### 性能指标
- [ ] UI响应时间 < 100ms
- [ ] 内存使用 < 200MB
- [ ] CPU使用率 < 10% (空闲时)

### 代码质量
- [ ] 所有测试通过
- [ ] 代码覆盖率 > 80%
- [ ] 无编译警告
- [ ] 代码格式规范

### 用户体验
- [ ] UI直观易用
- [ ] 操作流程顺畅
- [ ] 错误提示清晰
- [ ] 帮助文档完整

---

## 📚 参考资料

- Makepad Book: https://book.makepad.rs/
- Makepad Studio 源码: https://github.com/makepad/makepad
- Makepad Examples: makepad-widgets 示例

---

## 📝 备注

### 可选功能 (Phase 3.5)
- Clash API 集成 (查询运行状态)
- 系统托盘图标
- 开机自启动
- 快捷键支持

### 后续优化 (Phase 4)
- 自动故障切换
- 连接监控和统计
- 性能优化
- 更多健康检查方式

---

**文档版本**: 1.0
**创建时间**: 2026-02-02
**最后更新**: 2026-02-02
**作者**: Claude Sonnet 4.5
