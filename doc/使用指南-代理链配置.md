# Clash Chain Patcher 使用指南 - 代理链配置

## 概述

本项目提供两种方式来使用代理链（Proxy Chain）：

1. **静态配置方式**（v0.1.x）：修改Clash配置文件，重启Clash生效
2. **动态代理方式**（v0.2.0开发中）：运行本地代理服务器，无需修改原始配置

---

## 方式1：静态配置修改（现有功能）

### 工作原理

```
┌─────────────┐
│  Clash GUI  │  用户通过GUI选择要添加代理链的节点
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────────────────┐
│  Clash Chain Patcher (GUI)                      │
│  1. 读取Clash配置文件                            │
│  2. 在proxies中添加SOCKS5节点                    │
│  3. 创建relay代理组（原节点 → SOCKS5 → 目标）     │
│  4. 保存修改后的配置文件                          │
└──────┬──────────────────────────────────────────┘
       │
       ▼
┌─────────────┐
│  Clash配置  │  修改后的YAML文件
│  (静态)     │  需要重启Clash才能生效
└─────────────┘
```

### 使用步骤

1. **启动GUI程序**
   ```bash
   cargo run --release
   ```

2. **加载Clash配置**
   - 点击"Load Config"按钮
   - 选择你的Clash配置文件（通常在 `~/.config/clash/config.yaml`）

3. **配置SOCKS5代理**
   输入上游SOCKS5代理信息，支持两种格式：
   - 格式1: `user:pass@host:port`
   - 格式2: `host:port:user:pass`

   例如：`64.32.179.160:60088:ZUvGbvjcI52P:0UxQRzGfZoup`

4. **选择要添加链的节点**
   - 勾选要添加代理链的节点
   - 可以多选

5. **预览并保存**
   - 点击"Preview"查看修改效果
   - 点击"Apply"保存配置
   - **重启Clash**使配置生效

### 优点
- ✅ 配置持久化，重启后仍然有效
- ✅ 完全由Clash管理，稳定可靠
- ✅ 支持Clash的所有功能（规则、策略组等）

### 缺点
- ❌ 每次修改都需要编辑配置文件
- ❌ 需要重启Clash
- ❌ 修改永久保存在配置文件中
- ❌ 难以临时测试不同的代理链

---

## 方式2：动态代理服务器（v0.2.0 - 开发中）

### 工作原理

```
┌────────────┐
│   Clash    │  使用本地SOCKS5代理（127.0.0.1:10808）
│  (TUN模式) │  系统所有流量通过Clash
└─────┬──────┘
      │
      │ 通过Clash配置中的SOCKS5节点
      ▼
┌──────────────────────────────────────────────────┐
│  本地动态代理服务器 (127.0.0.1:10808)             │
│  - 接收Clash的连接请求                            │
│  - 转发到配置的上游SOCKS5代理                      │
│  - 支持多个上游，自动选择和故障切换                 │
│  - 实时健康检查                                    │
└─────┬────────────────────────────────────────────┘
      │
      │ SOCKS5协议连接
      ▼
┌──────────────────────────┐
│  上游SOCKS5代理           │  你的真实代理服务器
│  (64.32.179.160:60088)   │  64.32.179.160:60088
└─────┬────────────────────┘
      │
      ▼
┌──────────────────────────┐
│  目标网站                 │  最终访问的网站
│  (httpbin.org, google等) │
└──────────────────────────┘
```

### 流量路径

```
你的应用 → Clash (TUN/系统代理) → 本地代理 (127.0.0.1:10808)
        → 上游SOCKS5 → 互联网
```

### Clash配置示例

在你的Clash配置文件中添加这个节点：

```yaml
proxies:
  # ... 你现有的其他代理节点 ...

  # 添加本地动态代理链节点
  - name: "Local-Chain-Proxy"
    type: socks5
    server: 127.0.0.1
    port: 10808
    # 不需要认证（本地连接）

proxy-groups:
  - name: "PROXY"
    type: select
    proxies:
      - "Local-Chain-Proxy"  # 添加到你的代理组
      - "你的其他节点1"
      - "你的其他节点2"
```

### 使用步骤

#### 方式A：命令行启动（当前可用）

1. **启动本地代理服务器**
   ```bash
   # 在终端1运行
   RUST_LOG=info cargo run --example proxy_server -- \
     --listen 127.0.0.1:10808 \
     --upstream 64.32.179.160:60088:ZUvGbvjcI52P:0UxQRzGfZoup
   ```

2. **配置Clash**
   - 编辑Clash配置文件（只需要做一次）
   - 添加上面的SOCKS5节点配置
   - 重启Clash

3. **在Clash中选择节点**
   - 在Clash界面中选择 "Local-Chain-Proxy" 节点
   - 所有流量现在会经过：Clash → 本地代理 → 上游代理 → 目标

4. **验证代理工作**
   ```bash
   # 在终端2运行
   curl http://ping0.cc
   # 应该显示：64.32.179.160
   ```

5. **更换上游代理**
   - 只需要重启本地代理服务器，指定新的上游即可
   - **不需要修改Clash配置**
   - **不需要重启Clash**

#### 方式B：GUI启动（未来版本）

未来将提供GUI界面：
- 在GUI中配置多个上游代理
- 实时查看连接状态和统计
- 图形化管理健康检查和故障切换
- 一键启动/停止代理服务器

### 优点
- ✅ **动态切换**：更换上游无需修改Clash配置
- ✅ **临时测试**：轻松测试不同的代理链
- ✅ **多上游管理**：支持多个上游，自动选择最优
- ✅ **健康检查**：自动检测上游状态，故障自动切换
- ✅ **实时监控**：查看连接统计、流量、延迟
- ✅ **灵活配置**：通过GUI或命令行动态调整

### 缺点
- ❌ 需要额外运行一个程序（本地代理服务器）
- ❌ 本地代理停止时连接会失败
- ❌ 多一层转发，理论上有轻微延迟增加（实测可忽略）

---

## 两种方式对比

| 特性 | 静态配置 | 动态代理 |
|------|---------|---------|
| 配置难度 | 简单 | 中等 |
| 更换代理 | 需修改配置+重启 | 无需重启，动态切换 |
| 测试便利性 | 低 | 高 |
| 多上游支持 | 手动配置 | 自动管理 |
| 故障切换 | 手动 | 自动 |
| 性能监控 | 无 | 有 |
| 依赖 | 仅Clash | Clash + 本地程序 |
| 适用场景 | 长期固定代理 | 需要频繁切换/测试 |

---

## 实际使用场景

### 场景1：长期使用固定代理链
**推荐**：静态配置方式
- 配置一次，长期使用
- 不需要额外运行程序
- 与Clash完全集成

### 场景2：频繁测试不同代理
**推荐**：动态代理方式
- 快速切换不同上游
- 实时查看效果
- 不影响Clash配置

### 场景3：多个上游，需要故障切换
**推荐**：动态代理方式
- 自动检测上游健康状态
- 故障时自动切换
- 负载均衡

### 场景4：临时需要代理链
**推荐**：动态代理方式
- 启动时使用
- 不用时停止
- 不修改永久配置

---

## 为什么会有上游SOCKS5代理IP？

### 原理解释

当你访问网站（如ping0.cc）查询"我的IP是什么"时：

1. **不使用代理**
   ```
   你的电脑 → 目标网站
   网站看到的IP：你的本地IP
   ```

2. **使用代理链**
   ```
   你的电脑 → 本地代理 (127.0.0.1:10808)
            → 上游SOCKS5 (64.32.179.160:60088)
            → 目标网站

   网站看到的IP：上游SOCKS5的IP (64.32.179.160)
   ```

### 为什么是这样？

因为：
- **本地代理** (127.0.0.1:10808) 只是一个"中转站"
- 它接收Clash的请求，然后**通过上游SOCKS5**发起真正的连接
- 目标网站只能看到**最后一个代理服务器的IP**
- 也就是上游SOCKS5的IP：64.32.179.160

### 类比理解

就像邮寄包裹：
1. **你**：原始发件人（本地电脑）
2. **本地代理**：你的快递点（127.0.0.1:10808）
3. **上游SOCKS5**：转运中心（64.32.179.160）
4. **目标网站**：收件人

收件人只看到转运中心的地址，而不是你的地址。

### 验证

```bash
# 不使用代理
curl http://ping0.cc
# 输出：你的真实IP

# 使用代理链
curl --proxy socks5://127.0.0.1:10808 http://ping0.cc
# 输出：64.32.179.160（上游代理IP）
```

---

## 下一步

### 当前状态（2026-02-02）
- ✅ Core模块完成（单上游代理）
- ✅ 命令行工具可用
- ✅ 已验证与Clash兼容

### 即将开发（Task 2.x）
- ⏳ 多上游管理
- ⏳ 健康检查
- ⏳ 自动故障切换
- ⏳ GUI集成

### 未来功能（v1.0）
- ⏳ 负载均衡策略
- ⏳ 流量统计和监控
- ⏳ 规则路由
- ⏳ 配置持久化

---

## 常见问题

### Q1: 为什么要用本地代理，不能直接连上游？
A: Clash已经支持SOCKS5，但：
- 配置固定在YAML中，难以动态切换
- 不支持多上游故障切换
- 没有健康检查功能
- 本地代理层提供这些高级功能

### Q2: 会不会影响速度？
A: 影响极小：
- 本地转发延迟 < 1ms（127.0.0.1通信）
- 瓶颈在上游代理和网络，不在本地转发
- 实测与直连上游SOCKS5性能几乎相同

### Q3: 本地代理挂了怎么办？
A: 两个解决方案：
- 方案1：在Clash中保留备用节点，手动切换
- 方案2：未来版本将支持作为系统服务自动重启

### Q4: 可以不用Clash吗？
A: 可以！本地代理是标准SOCKS5服务器：
- 可以配置在任何支持SOCKS5的应用中
- 浏览器、命令行工具、其他代理软件都可以使用
- Clash只是推荐的使用方式之一

---

最后更新：2026-02-02
