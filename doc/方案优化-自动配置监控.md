# æ–¹æ¡ˆä¼˜åŒ– - è‡ªåŠ¨é…ç½®ç›‘æ§ä¸æ›´æ–°

## ç”¨æˆ·éœ€æ±‚åˆ†æ

åŸºäºç”¨æˆ·åé¦ˆï¼Œç›¸æ¯”å¤æ‚çš„OSçº§åˆ«æ‹¦æˆªæ–¹æ¡ˆï¼ˆProxifierã€iptablesï¼‰ï¼Œæ›´ç®€å•å®ç”¨çš„æ–¹æ¡ˆæ˜¯ï¼š

**æ ¸å¿ƒæ€è·¯**ï¼šåœ¨GUIä¸­ç®¡ç†ä¸Šæ¸¸ä»£ç† + è‡ªåŠ¨ç›‘æ§Clashé…ç½®å˜åŒ– + è‡ªåŠ¨åˆå¹¶é…ç½®

---

## æ–¹æ¡ˆå¯¹æ¯”

### âŒ ä¹‹å‰çš„å¤æ‚æ–¹æ¡ˆï¼ˆä¸æ¨èï¼‰

**Linux**: iptables + redsocks
**Windows**: Proxifier ($39.95)
**macOS**: Proxifier / proxychains-ng

**ç¼ºç‚¹**ï¼š
- éœ€è¦ç³»ç»Ÿçº§æƒé™
- é…ç½®å¤æ‚
- Windowséœ€è¦ä»˜è´¹è½¯ä»¶
- ç”¨æˆ·ä½“éªŒå·®

### âœ… ä¼˜åŒ–åçš„ç®€å•æ–¹æ¡ˆï¼ˆæ¨èï¼‰

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. GUIç®¡ç†ä¸Šæ¸¸ä»£ç†åˆ—è¡¨
2. å¥åº·æ£€æŸ¥å’ŒçŠ¶æ€æ˜¾ç¤º
3. ç›‘æ§Clashé…ç½®æ–‡ä»¶å˜åŒ–
4. è‡ªåŠ¨åˆå¹¶Local-Chain-Proxyåˆ°é…ç½®
5. å¯é€‰ï¼šè°ƒç”¨Clash APIè‡ªåŠ¨åˆ‡æ¢èŠ‚ç‚¹

**ä¼˜ç‚¹**ï¼š
- âœ… çº¯é…ç½®æ–‡ä»¶æ“ä½œï¼Œæ— éœ€ç³»ç»Ÿæƒé™
- âœ… è·¨å¹³å°å…¼å®¹ï¼ˆWindows/macOS/Linuxï¼‰
- âœ… ç”¨æˆ·ä½“éªŒå¥½ï¼ˆGUIæ“ä½œï¼‰
- âœ… å®Œå…¨å…è´¹
- âœ… ç¬¦åˆé¡¹ç›®è®¾è®¡ç†å¿µ

---

## å®ç°æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GUI (Makepad)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ä¸Šæ¸¸ä»£ç†ç®¡ç†   â”‚  â”‚ Clashé…ç½®ç›‘æ§ â”‚  â”‚ å¥åº·æ£€æŸ¥é¢æ¿  â”‚ â”‚
â”‚  â”‚ - æ·»åŠ /åˆ é™¤   â”‚  â”‚ - æ–‡ä»¶è·¯å¾„è®¾ç½®â”‚  â”‚ - å»¶è¿Ÿæ˜¾ç¤º   â”‚ â”‚
â”‚  â”‚ - ç¼–è¾‘é…ç½®    â”‚  â”‚ - è‡ªåŠ¨ç›‘æ§å¼€å…³â”‚  â”‚ - å¯ç”¨æ€§çŠ¶æ€ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                  â”‚                  â”‚
           â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Core æ¨¡å—                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ æœ¬åœ°ä»£ç†æœåŠ¡å™¨  â”‚  â”‚ é…ç½®æ–‡ä»¶ç›‘æ§å™¨   â”‚  â”‚ å¥åº·æ£€æŸ¥å™¨ â”‚â”‚
â”‚  â”‚ (å·²å®ç°)       â”‚  â”‚ (å¾…å®ç°)        â”‚  â”‚ (å¾…å®ç°)   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Clashé…ç½®åˆå¹¶å™¨ (åŸºäºç°æœ‰Pythonè„šæœ¬)                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Clash API å®¢æˆ·ç«¯ (å¯é€‰)                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è¯¦ç»†åŠŸèƒ½è®¾è®¡

### 1. ä¸Šæ¸¸ä»£ç†ç®¡ç†

#### GUIç•Œé¢
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸Šæ¸¸ä»£ç†åˆ—è¡¨                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚å¯ç”¨ â”‚ åç§°          â”‚ åœ°å€  â”‚ å»¶è¿Ÿ   â”‚ çŠ¶æ€     â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ âœ“   â”‚ é¦™æ¸¯ä»£ç†1     â”‚ 64...â”‚ 120ms  â”‚ âœ… æ­£å¸¸  â”‚ â”‚
â”‚ â”‚ âœ“   â”‚ ç¾å›½ä»£ç†2     â”‚ 45...â”‚ 300ms  â”‚ âœ… æ­£å¸¸  â”‚ â”‚
â”‚ â”‚ â–¡   â”‚ æ—¥æœ¬ä»£ç†3     â”‚ 23...â”‚ -      â”‚ âš ï¸ ç¦ç”¨  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                      â”‚
â”‚ [æ·»åŠ ä»£ç†] [ç¼–è¾‘] [åˆ é™¤] [æµ‹è¯•è¿æ¥]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ•°æ®ç»“æ„
```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct UpstreamProxy {
    pub id: String,
    pub name: String,
    pub enabled: bool,
    pub config: UpstreamConfig, // å¤ç”¨ç°æœ‰ç»“æ„
    pub health: ProxyHealth,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ProxyHealth {
    pub status: HealthStatus,
    pub latency_ms: Option<u64>,
    pub last_check: Option<SystemTime>,
    pub error: Option<String>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum HealthStatus {
    Healthy,
    Unhealthy,
    Checking,
    Unknown,
}
```

#### åŠŸèƒ½
- æ·»åŠ /ç¼–è¾‘/åˆ é™¤ä¸Šæ¸¸ä»£ç†
- æ”¯æŒä¸¤ç§æ ¼å¼è¾“å…¥ï¼š`user:pass@host:port` å’Œ `host:port:user:pass`
- ä¿å­˜åˆ°é…ç½®æ–‡ä»¶ï¼ˆJSON/TOMLï¼‰
- å¯ç”¨/ç¦ç”¨æŸä¸ªä»£ç†

---

### 2. å¥åº·æ£€æŸ¥

#### æ£€æŸ¥é€»è¾‘
```rust
pub struct HealthChecker {
    interval: Duration,
    test_url: String, // é»˜è®¤ http://www.gstatic.com/generate_204
}

impl HealthChecker {
    pub async fn check_proxy(&self, proxy: &UpstreamConfig) -> ProxyHealth {
        let start = Instant::now();

        match self.test_connection(proxy).await {
            Ok(_) => ProxyHealth {
                status: HealthStatus::Healthy,
                latency_ms: Some(start.elapsed().as_millis() as u64),
                last_check: Some(SystemTime::now()),
                error: None,
            },
            Err(e) => ProxyHealth {
                status: HealthStatus::Unhealthy,
                latency_ms: None,
                last_check: Some(SystemTime::now()),
                error: Some(e.to_string()),
            },
        }
    }

    async fn test_connection(&self, proxy: &UpstreamConfig) -> Result<()> {
        // 1. è¿æ¥åˆ°SOCKS5ä»£ç†
        let stream = TcpStream::connect(format!("{}:{}", proxy.host, proxy.port)).await?;

        // 2. æ‰§è¡ŒSOCKS5æ¡æ‰‹
        let mut socks = Socks5Stream::use_stream(
            stream,
            Some((proxy.username.clone(), proxy.password.clone())),
            "www.gstatic.com:80".parse().unwrap(),
        ).await?;

        // 3. å‘é€HTTPè¯·æ±‚
        socks.write_all(b"GET /generate_204 HTTP/1.0\r\n\r\n").await?;

        // 4. è¯»å–å“åº”
        let mut buf = [0u8; 256];
        let n = socks.read(&mut buf).await?;

        // 5. éªŒè¯204çŠ¶æ€ç 
        if buf[..n].windows(15).any(|w| w == b"HTTP/1.0 204") {
            Ok(())
        } else {
            Err(anyhow!("Unexpected response"))
        }
    }
}
```

#### è‡ªåŠ¨æ£€æŸ¥
- é»˜è®¤æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
- ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨è§¦å‘æ£€æŸ¥
- æ£€æŸ¥å¤±è´¥3æ¬¡åæ ‡è®°ä¸ºä¸å¥åº·

---

### 3. Clashé…ç½®ç›‘æ§

#### GUIç•Œé¢
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Clashé…ç½®ç›‘æ§                                        â”‚
â”‚                                                      â”‚
â”‚ é…ç½®æ–‡ä»¶è·¯å¾„:                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ /Users/xxx/.config/clash/config.yaml           â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ [æµè§ˆ...] [è‡ªåŠ¨æ£€æµ‹]                                 â”‚
â”‚                                                      â”‚
â”‚ â–¡ å¯ç”¨è‡ªåŠ¨ç›‘æ§                                       â”‚
â”‚ â–¡ è‡ªåŠ¨åˆå¹¶é…ç½®ï¼ˆè®¢é˜…æ›´æ–°åï¼‰                         â”‚
â”‚ â–¡ è‡ªåŠ¨åˆ‡æ¢èŠ‚ç‚¹ï¼ˆéœ€è¦Clash APIï¼‰                      â”‚
â”‚                                                      â”‚
â”‚ ç›‘æ§çŠ¶æ€: âš« å·²åœæ­¢ / ğŸŸ¢ ç›‘æ§ä¸­                       â”‚
â”‚ æœ€åæ›´æ–°: 2026-02-02 18:30:45                       â”‚
â”‚ ä¸Šæ¬¡åˆå¹¶: 2026-02-02 18:31:02 (æˆåŠŸ)                â”‚
â”‚                                                      â”‚
â”‚ [æ‰‹åŠ¨åˆå¹¶] [æŸ¥çœ‹å¤‡ä»½]                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é…ç½®æ–‡ä»¶ç›‘æ§å™¨
```rust
use notify::{Watcher, RecursiveMode, Event};

pub struct ClashConfigWatcher {
    config_path: PathBuf,
    watcher: RecommendedWatcher,
    tx: mpsc::Sender<ConfigEvent>,
}

#[derive(Debug)]
pub enum ConfigEvent {
    FileChanged,
    FileCreated,
    FileDeleted,
}

impl ClashConfigWatcher {
    pub fn new(config_path: PathBuf) -> Result<Self> {
        let (tx, rx) = mpsc::channel();

        let mut watcher = notify::recommended_watcher(move |res: Result<Event, _>| {
            match res {
                Ok(event) => {
                    if event.paths.contains(&config_path) {
                        let _ = tx.send(ConfigEvent::FileChanged);
                    }
                }
                Err(e) => error!("Watch error: {:?}", e),
            }
        })?;

        watcher.watch(&config_path, RecursiveMode::NonRecursive)?;

        Ok(Self { config_path, watcher, tx })
    }

    pub async fn start(&mut self) -> Result<()> {
        while let Some(event) = self.rx.recv().await {
            match event {
                ConfigEvent::FileChanged => {
                    info!("Clash config changed, triggering merge...");
                    // ç­‰å¾…2ç§’ç¡®ä¿æ–‡ä»¶å†™å…¥å®Œæˆ
                    tokio::time::sleep(Duration::from_secs(2)).await;
                    self.merge_config().await?;
                }
                _ => {}
            }
        }
        Ok(())
    }
}
```

---

### 4. é…ç½®åˆå¹¶å™¨

#### å¤ç”¨ç°æœ‰Pythonè„šæœ¬
```rust
use std::process::Command;

pub struct ConfigMerger {
    script_path: PathBuf,
    local_proxy_name: String,
    local_proxy_port: u16,
}

impl ConfigMerger {
    pub async fn merge_config(&self, config_path: &Path) -> Result<()> {
        // è°ƒç”¨ç°æœ‰çš„ merge-clash-config.sh è„šæœ¬
        let output = Command::new(&self.script_path)
            .arg(config_path)
            .output()?;

        if output.status.success() {
            info!("Config merged successfully");
            Ok(())
        } else {
            let stderr = String::from_utf8_lossy(&output.stderr);
            Err(anyhow!("Merge failed: {}", stderr))
        }
    }
}
```

#### æˆ–è€…ç”¨çº¯Rustå®ç°
```rust
use serde_yaml::{self, Value};

pub struct ConfigMerger {
    local_proxy_name: String,
    local_proxy_port: u16,
}

impl ConfigMerger {
    pub fn merge_config(&self, config_path: &Path) -> Result<()> {
        // 1. è¯»å–é…ç½®
        let content = fs::read_to_string(config_path)?;
        let mut config: Value = serde_yaml::from_str(&content)?;

        // 2. å¤‡ä»½
        let backup_path = format!("{}.backup-{}",
            config_path.display(),
            chrono::Local::now().format("%Y%m%d-%H%M%S")
        );
        fs::copy(config_path, &backup_path)?;

        // 3. æ·»åŠ æœ¬åœ°ä»£ç†èŠ‚ç‚¹
        let proxies = config.get_mut("proxies")
            .and_then(|v| v.as_sequence_mut())
            .ok_or_else(|| anyhow!("Invalid proxies section"))?;

        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        let exists = proxies.iter().any(|p| {
            p.get("name")
                .and_then(|n| n.as_str())
                .map(|n| n == self.local_proxy_name)
                .unwrap_or(false)
        });

        if !exists {
            let local_proxy = serde_yaml::to_value(serde_json::json!({
                "name": self.local_proxy_name,
                "type": "socks5",
                "server": "127.0.0.1",
                "port": self.local_proxy_port
            }))?;
            proxies.push(local_proxy);
        }

        // 4. æ·»åŠ åˆ°ä»£ç†ç»„
        let groups = config.get_mut("proxy-groups")
            .and_then(|v| v.as_sequence_mut())
            .ok_or_else(|| anyhow!("Invalid proxy-groups section"))?;

        for group in groups {
            if group.get("type").and_then(|t| t.as_str()) == Some("select") {
                let group_proxies = group.get_mut("proxies")
                    .and_then(|p| p.as_sequence_mut())
                    .ok_or_else(|| anyhow!("Invalid group proxies"))?;

                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                let exists = group_proxies.iter().any(|p| {
                    p.as_str().map(|s| s == self.local_proxy_name).unwrap_or(false)
                });

                if !exists {
                    group_proxies.insert(0, Value::String(self.local_proxy_name.clone()));
                }
            }
        }

        // 5. å†™å›æ–‡ä»¶
        let merged = serde_yaml::to_string(&config)?;
        fs::write(config_path, merged)?;

        info!("Config merged: {}", config_path.display());
        Ok(())
    }
}
```

---

### 5. Clash APIé›†æˆï¼ˆå¯é€‰ï¼‰

#### è‡ªåŠ¨åˆ‡æ¢èŠ‚ç‚¹
```rust
pub struct ClashApiClient {
    base_url: String,
    secret: Option<String>,
    client: reqwest::Client,
}

impl ClashApiClient {
    pub fn new(host: &str, port: u16, secret: Option<String>) -> Self {
        Self {
            base_url: format!("http://{}:{}", host, port),
            secret,
            client: reqwest::Client::new(),
        }
    }

    pub async fn switch_proxy_group(&self, group: &str, proxy: &str) -> Result<()> {
        let url = format!("{}/proxies/{}", self.base_url, group);

        let mut req = self.client
            .put(&url)
            .json(&serde_json::json!({ "name": proxy }));

        if let Some(secret) = &self.secret {
            req = req.header("Authorization", format!("Bearer {}", secret));
        }

        let resp = req.send().await?;

        if resp.status().is_success() {
            info!("Switched {} to {}", group, proxy);
            Ok(())
        } else {
            Err(anyhow!("Failed to switch proxy: {}", resp.status()))
        }
    }

    pub async fn auto_switch_all_groups(&self, proxy_name: &str) -> Result<()> {
        // è·å–æ‰€æœ‰ä»£ç†ç»„
        let proxies = self.get_proxies().await?;

        // éå†æ‰€æœ‰selectç±»å‹çš„ç»„
        if let Some(proxy_map) = proxies["proxies"].as_object() {
            for (group_name, group_info) in proxy_map {
                if group_info["type"] == "Selector" {
                    // æ£€æŸ¥ç»„ä¸­æ˜¯å¦åŒ…å«ç›®æ ‡èŠ‚ç‚¹
                    if let Some(all) = group_info["all"].as_array() {
                        if all.iter().any(|n| n.as_str() == Some(proxy_name)) {
                            self.switch_proxy_group(group_name, proxy_name).await?;
                        }
                    }
                }
            }
        }

        Ok(())
    }

    async fn get_proxies(&self) -> Result<serde_json::Value> {
        let url = format!("{}/proxies", self.base_url);
        let mut req = self.client.get(&url);

        if let Some(secret) = &self.secret {
            req = req.header("Authorization", format!("Bearer {}", secret));
        }

        let resp = req.send().await?;
        Ok(resp.json().await?)
    }
}
```

---

## å®Œæ•´å·¥ä½œæµç¨‹

### 1. åˆæ¬¡é…ç½®

```
ç”¨æˆ·æ“ä½œ                              ç³»ç»Ÿå“åº”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. æ‰“å¼€GUI                           â†’ åŠ è½½ä¿å­˜çš„é…ç½®
2. æ·»åŠ ä¸Šæ¸¸SOCKS5ä»£ç†                â†’ ä¿å­˜åˆ°é…ç½®æ–‡ä»¶
   - åç§°: é¦™æ¸¯ä»£ç†1
   - åœ°å€: 64.32.179.160:60088
   - è®¤è¯: user:pass
3. ç‚¹å‡»"æµ‹è¯•è¿æ¥"                    â†’ æ‰§è¡Œå¥åº·æ£€æŸ¥
                                     â†’ æ˜¾ç¤ºå»¶è¿Ÿ: 120ms âœ…
4. è®¾ç½®Clashé…ç½®è·¯å¾„                 â†’ éªŒè¯æ–‡ä»¶å­˜åœ¨
   /Users/xxx/.config/clash/config.yaml
5. å¯ç”¨"è‡ªåŠ¨ç›‘æ§"                    â†’ å¯åŠ¨æ–‡ä»¶ç›‘æ§å™¨
6. ç‚¹å‡»"å¯åŠ¨ä»£ç†æœåŠ¡å™¨"              â†’ å¯åŠ¨æœ¬åœ°SOCKS5æœåŠ¡å™¨
                                       ç›‘å¬ 127.0.0.1:10808
7. ç‚¹å‡»"æ‰‹åŠ¨åˆå¹¶é…ç½®"                â†’ æ‰§è¡Œé…ç½®åˆå¹¶
                                     â†’ å¤‡ä»½åŸé…ç½®
                                     â†’ æ·»åŠ Local-Chain-Proxy
                                     â†’ æç¤ºç”¨æˆ·é‡å¯Clash
8. é‡å¯Clash                         â†’ (æ‰‹åŠ¨æ“ä½œ)
9. åœ¨Clashä¸­é€‰æ‹©                     â†’ (æ‰‹åŠ¨æ“ä½œ)
   "Local-Chain-Proxy"èŠ‚ç‚¹
```

### 2. è®¢é˜…æ›´æ–°æ—¶ï¼ˆè‡ªåŠ¨ï¼‰

```
ç³»ç»Ÿäº‹ä»¶                              ç³»ç»Ÿå“åº”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. ç”¨æˆ·åœ¨Clashä¸­ç‚¹å‡»"æ›´æ–°è®¢é˜…"       â†’ Clashä¸‹è½½æ–°é…ç½®
                                     â†’ è¦†ç›–config.yaml
2. ConfigWatcheræ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–       â†’ è§¦å‘ConfigEvent::FileChanged
3. ç­‰å¾…2ç§’ï¼ˆç¡®ä¿å†™å…¥å®Œæˆï¼‰           â†’ tokio::time::sleep(2s)
4. è‡ªåŠ¨è¿è¡Œé…ç½®åˆå¹¶                  â†’ ConfigMerger::merge_config()
                                     â†’ å¤‡ä»½: config.yaml.backup-xxx
                                     â†’ æ·»åŠ Local-Chain-Proxy
                                     â†’ å†™å›config.yaml
5. (å¯é€‰) è°ƒç”¨Clash API              â†’ ClashApiClient::reload_config()
                                     â†’ ClashApiClient::auto_switch_all_groups()
6. GUIæ˜¾ç¤ºé€šçŸ¥                       â†’ "âœ… é…ç½®å·²è‡ªåŠ¨æ›´æ–°"
```

### 3. å¥åº·æ£€æŸ¥ï¼ˆåå°ï¼‰

```
å®šæ—¶ä»»åŠ¡                              ç³»ç»Ÿå“åº”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ¯5åˆ†é’Ÿï¼š
1. éå†æ‰€æœ‰å¯ç”¨çš„ä¸Šæ¸¸ä»£ç†            â†’ for proxy in enabled_proxies
2. æ‰§è¡Œå¥åº·æ£€æŸ¥                      â†’ HealthChecker::check_proxy()
                                     â†’ è¿æ¥æµ‹è¯•
                                     â†’ å»¶è¿Ÿæµ‹é‡
3. æ›´æ–°çŠ¶æ€                          â†’ ProxyHealth.status = Healthy/Unhealthy
                                     â†’ ProxyHealth.latency_ms = 120
4. GUIå®æ—¶æ˜¾ç¤º                       â†’ æ›´æ–°ç•Œé¢
5. (å¯é€‰) è‡ªåŠ¨åˆ‡æ¢                   â†’ å¦‚æœå½“å‰ä»£ç†ä¸å¥åº·
                                       åˆ‡æ¢åˆ°å¥åº·çš„ä»£ç†
```

---

## å®ç°ä»»åŠ¡åˆ†è§£

### Phase 1: æ ¸å¿ƒåŠŸèƒ½ï¼ˆ2-3å¤©ï¼‰

#### Task 1.1: ä¸Šæ¸¸ä»£ç†ç®¡ç†æ•°æ®ç»“æ„
- [ ] å®šä¹‰ `UpstreamProxy` ç»“æ„
- [ ] å®šä¹‰ `ProxyHealth` ç»“æ„
- [ ] å®ç°é…ç½®æ–‡ä»¶åºåˆ—åŒ–/ååºåˆ—åŒ–
- [ ] å®ç°å¢åˆ æ”¹æŸ¥API

#### Task 1.2: é…ç½®æŒä¹…åŒ–
- [ ] é€‰æ‹©é…ç½®æ ¼å¼ï¼ˆJSON/TOMLï¼‰
- [ ] å®ç°é…ç½®æ–‡ä»¶è¯»å†™
- [ ] é»˜è®¤é…ç½®è·¯å¾„ï¼š`~/.config/clash-chain-patcher/config.json`

#### Task 1.3: å¥åº·æ£€æŸ¥å™¨
- [ ] å®ç° `HealthChecker::check_proxy()`
- [ ] SOCKS5è¿æ¥æµ‹è¯•
- [ ] å»¶è¿Ÿæµ‹é‡
- [ ] åå°å®šæ—¶æ£€æŸ¥ä»»åŠ¡

#### Task 1.4: Clashé…ç½®ç›‘æ§
- [ ] é›†æˆ `notify` crate
- [ ] å®ç° `ClashConfigWatcher`
- [ ] æ–‡ä»¶å˜åŒ–æ£€æµ‹
- [ ] é˜²æŠ–å¤„ç†ï¼ˆ2ç§’å»¶è¿Ÿï¼‰

#### Task 1.5: é…ç½®åˆå¹¶å™¨
- [ ] æ–¹æ¡ˆA: è°ƒç”¨ç°æœ‰Pythonè„šæœ¬
- [ ] æ–¹æ¡ˆB: çº¯Rustå®ç°ï¼ˆåŸºäºserde_yamlï¼‰
- [ ] è‡ªåŠ¨å¤‡ä»½åŠŸèƒ½
- [ ] é”™è¯¯å¤„ç†å’Œå›æ»š

---

### Phase 2: GUIé›†æˆï¼ˆ3-4å¤©ï¼‰

#### Task 2.1: ä¸Šæ¸¸ä»£ç†ç®¡ç†ç•Œé¢
- [ ] ä»£ç†åˆ—è¡¨è§†å›¾
- [ ] æ·»åŠ /ç¼–è¾‘å¯¹è¯æ¡†
- [ ] åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
- [ ] å¯ç”¨/ç¦ç”¨åˆ‡æ¢

#### Task 2.2: å¥åº·çŠ¶æ€æ˜¾ç¤º
- [ ] å®æ—¶å»¶è¿Ÿæ˜¾ç¤º
- [ ] çŠ¶æ€å›¾æ ‡ï¼ˆâœ… âš ï¸ âŒï¼‰
- [ ] æ‰‹åŠ¨æµ‹è¯•æŒ‰é’®
- [ ] è‡ªåŠ¨åˆ·æ–°

#### Task 2.3: Clashé…ç½®ç›‘æ§ç•Œé¢
- [ ] é…ç½®è·¯å¾„è¾“å…¥/æµè§ˆ
- [ ] è‡ªåŠ¨æ£€æµ‹å¸¸è§è·¯å¾„
- [ ] ç›‘æ§çŠ¶æ€æŒ‡ç¤º
- [ ] æ‰‹åŠ¨åˆå¹¶æŒ‰é’®
- [ ] å¤‡ä»½åˆ—è¡¨æŸ¥çœ‹

#### Task 2.4: ä¸»ç•Œé¢æ•´åˆ
- [ ] ç»Ÿä¸€å¸ƒå±€
- [ ] å¯åŠ¨/åœæ­¢æŒ‰é’®
- [ ] çŠ¶æ€æ 
- [ ] æ—¥å¿—é¢æ¿

---

### Phase 3: å¯é€‰å¢å¼ºåŠŸèƒ½ï¼ˆ2-3å¤©ï¼‰

#### Task 3.1: Clash APIé›†æˆ
- [ ] å®ç° `ClashApiClient`
- [ ] è‡ªåŠ¨é‡è½½é…ç½®
- [ ] è‡ªåŠ¨åˆ‡æ¢èŠ‚ç‚¹
- [ ] APIé…ç½®ç•Œé¢ï¼ˆåœ°å€ã€ç«¯å£ã€å¯†é’¥ï¼‰

#### Task 3.2: é«˜çº§åŠŸèƒ½
- [ ] å¤šä¸Šæ¸¸è‡ªåŠ¨é€‰æ‹©ï¼ˆæœ€ä½å»¶è¿Ÿï¼‰
- [ ] æ•…éšœè‡ªåŠ¨åˆ‡æ¢
- [ ] æµé‡ç»Ÿè®¡
- [ ] é…ç½®å¯¼å…¥/å¯¼å‡º

#### Task 3.3: ç³»ç»Ÿé›†æˆ
- [ ] ç³»ç»Ÿæ‰˜ç›˜å›¾æ ‡
- [ ] å¼€æœºè‡ªå¯åŠ¨
- [ ] åå°è¿è¡Œæ¨¡å¼
- [ ] é€šçŸ¥ä¸­å¿ƒé›†æˆ

---

## ä¾èµ–åº“

```toml
[dependencies]
# ç°æœ‰ä¾èµ–
tokio = { version = "1.42", features = ["full"] }
anyhow = "1.0"
tracing = "0.1"
serde = { version = "1.0", features = ["derive"] }

# æ–°å¢ä¾èµ–
notify = "7.0"  # æ–‡ä»¶ç›‘æ§
serde_yaml = "0.9"  # Clashé…ç½®è§£æ
serde_json = "1.0"  # é…ç½®æ–‡ä»¶æ ¼å¼
reqwest = { version = "0.12", features = ["json"] }  # Clash API
chrono = "0.4"  # æ—¶é—´æˆ³
```

---

## é…ç½®æ–‡ä»¶ç¤ºä¾‹

### `~/.config/clash-chain-patcher/config.json`

```json
{
  "upstream_proxies": [
    {
      "id": "proxy-1",
      "name": "é¦™æ¸¯ä»£ç†1",
      "enabled": true,
      "config": {
        "host": "64.32.179.160",
        "port": 60088,
        "username": "ZUvGbvjcI52P",
        "password": "0UxQRzGfZoup"
      },
      "health": {
        "status": "Healthy",
        "latency_ms": 120,
        "last_check": "2026-02-02T18:30:00Z",
        "error": null
      }
    },
    {
      "id": "proxy-2",
      "name": "ç¾å›½ä»£ç†1",
      "enabled": false,
      "config": {
        "host": "45.123.45.67",
        "port": 1080,
        "username": "user2",
        "password": "pass2"
      },
      "health": {
        "status": "Unknown",
        "latency_ms": null,
        "last_check": null,
        "error": null
      }
    }
  ],
  "clash": {
    "config_path": "/Users/xxx/.config/clash/config.yaml",
    "auto_monitor": true,
    "auto_merge": true,
    "api": {
      "enabled": false,
      "host": "127.0.0.1",
      "port": 9090,
      "secret": ""
    }
  },
  "local_proxy": {
    "name": "Local-Chain-Proxy",
    "listen": "127.0.0.1:10808"
  },
  "health_check": {
    "enabled": true,
    "interval_seconds": 300,
    "test_url": "http://www.gstatic.com/generate_204",
    "timeout_seconds": 10
  }
}
```

---

## ç”¨æˆ·ä½“éªŒæµç¨‹

### ç†æƒ³æƒ…å†µï¼ˆå…¨è‡ªåŠ¨ï¼‰

```
1. ç”¨æˆ·ç¬¬ä¸€æ¬¡æ‰“å¼€GUI
   â†’ æ·»åŠ ä¸Šæ¸¸SOCKS5ä»£ç†
   â†’ è®¾ç½®Clashé…ç½®è·¯å¾„
   â†’ å¯ç”¨"è‡ªåŠ¨ç›‘æ§"
   â†’ å¯åŠ¨æœ¬åœ°ä»£ç†æœåŠ¡å™¨
   â†’ ç‚¹å‡»"æ‰‹åŠ¨åˆå¹¶"ï¼ˆç¬¬ä¸€æ¬¡ï¼‰
   â†’ é‡å¯Clash
   â†’ é€‰æ‹©Local-Chain-ProxyèŠ‚ç‚¹

2. ä¹‹åæ¯æ¬¡Clashè®¢é˜…æ›´æ–°
   â†’ ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹
   â†’ è‡ªåŠ¨åˆå¹¶é…ç½®
   â†’ (å¯é€‰) è‡ªåŠ¨é‡è½½Clash
   â†’ (å¯é€‰) è‡ªåŠ¨åˆ‡æ¢èŠ‚ç‚¹
   â†’ ç”¨æˆ·æ— éœ€ä»»ä½•æ“ä½œï¼
```

### ç®€åŒ–ç‰ˆï¼ˆåŠè‡ªåŠ¨ï¼‰

```
1. ç”¨æˆ·æ‰“å¼€GUI
   â†’ æ·»åŠ ä»£ç†
   â†’ è®¾ç½®è·¯å¾„
   â†’ å¯åŠ¨æœåŠ¡å™¨

2. Clashè®¢é˜…æ›´æ–°å
   â†’ GUIæ˜¾ç¤ºé€šçŸ¥ï¼š"æ£€æµ‹åˆ°é…ç½®æ›´æ–°"
   â†’ ç”¨æˆ·ç‚¹å‡»"åˆå¹¶é…ç½®"
   â†’ é‡å¯Clashï¼ˆæ‰‹åŠ¨ï¼‰
   â†’ é€‰æ‹©èŠ‚ç‚¹ï¼ˆæ‰‹åŠ¨ï¼‰
```

---

## ä¼˜åŠ¿æ€»ç»“

ç›¸æ¯”OSçº§åˆ«æ‹¦æˆªæ–¹æ¡ˆï¼ˆProxifierã€iptablesï¼‰ï¼Œè¿™ä¸ªæ–¹æ¡ˆï¼š

| ç‰¹æ€§ | OSæ‹¦æˆªæ–¹æ¡ˆ | é…ç½®ç›‘æ§æ–¹æ¡ˆ |
|-----|-----------|------------|
| è·¨å¹³å° | âŒ éœ€è¦ä¸åŒå·¥å…· | âœ… çº¯é…ç½®æ“ä½œ |
| ç³»ç»Ÿæƒé™ | âŒ éœ€è¦root/ç®¡ç†å‘˜ | âœ… æ— éœ€ç‰¹æ®Šæƒé™ |
| ç”¨æˆ·ä½“éªŒ | âŒ å¤æ‚é…ç½® | âœ… GUIæ“ä½œ |
| è‡ªåŠ¨åŒ–ç¨‹åº¦ | âš ï¸ æ‰‹åŠ¨é…ç½® | âœ… è‡ªåŠ¨ç›‘æ§åˆå¹¶ |
| æˆæœ¬ | âŒ Windowséœ€ä»˜è´¹ | âœ… å®Œå…¨å…è´¹ |
| ç»´æŠ¤éš¾åº¦ | âŒ éœ€è¦ç»´æŠ¤å¤šå¹³å°è„šæœ¬ | âœ… ç»Ÿä¸€Rustä»£ç  |
| ä¸Clashé›†æˆ | âŒ å¤–éƒ¨åŠ«æŒ | âœ… é…ç½®çº§åˆ«é›†æˆ |

---

## ä¸‹ä¸€æ­¥

å»ºè®®æŒ‰ç…§ä»¥ä¸‹é¡ºåºå®ç°ï¼š

1. **ç«‹å³å¼€å§‹**ï¼šPhase 1.1-1.3ï¼ˆæ ¸å¿ƒæ•°æ®ç»“æ„å’Œå¥åº·æ£€æŸ¥ï¼‰
2. **æœ¬å‘¨å®Œæˆ**ï¼šPhase 1.4-1.5ï¼ˆé…ç½®ç›‘æ§å’Œåˆå¹¶ï¼‰
3. **ä¸‹å‘¨å®Œæˆ**ï¼šPhase 2ï¼ˆGUIé›†æˆï¼‰
4. **å¯é€‰**ï¼šPhase 3ï¼ˆClash APIè‡ªåŠ¨åŒ–ï¼‰

---

æœ€åæ›´æ–°ï¼š2026-02-02
