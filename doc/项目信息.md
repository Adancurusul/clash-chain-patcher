# 项目信息

## 基本信息

- **项目名称**: Clash Chain Patcher
- **版本**: 0.1.2
- **语言**: Rust (Edition 2021)
- **许可证**: MIT
- **仓库**: https://github.com/user/clash-chain-patcher

## 项目描述

一个跨平台GUI工具,用于在Clash配置中添加SOCKS5代理链。支持两种工作模式:
1. 静态配置修改: 修改Clash YAML配置文件
2. 动态代理服务: 本地SOCKS5代理服务器(规划中)

## 技术栈

### 核心依赖

| 依赖 | 版本 | 用途 |
|------|------|------|
| makepad-widgets | 1.0 | GUI框架 |
| serde | 1.0 | 序列化/反序列化 |
| serde_yaml | 0.9 | YAML解析 |
| rfd | 0.14 | 文件对话框 |
| regex | 1.10 | 正则表达式 |

### 开发要求

- Rust 1.70+ (推荐 1.91+)
- Python 3.8+ (仅用于图标生成)
- cargo-packager 0.10.1 (用于打包)

## 项目结构

```
clash-chain-patcher/
├── src/
│   ├── main.rs          # 入口点 (22行)
│   ├── app.rs           # GUI应用 (554行)
│   └── patcher.rs       # 核心修改逻辑 (424行)
├── logo/                # 图标资源
│   ├── logo_32.png
│   ├── logo_48.png
│   ├── clash-chain-patcher.png
│   ├── app.ico          # Windows图标
│   └── AppIcon.icns     # macOS图标
├── scripts/             # 构建脚本
│   ├── generate_icons.py
│   └── bundle_macos.sh
├── packaging/           # 打包辅助工具
│   └── before-packaging-command/
├── .github/workflows/   # CI/CD配置
│   └── release.yml      # 发布工作流
├── dist/                # 构建输出目录
├── doc/                 # 开发文档
└── Cargo.toml           # 项目配置
```

## 架构设计

### 模块划分

```
┌─────────────────────────────────────────┐
│           main.rs (Entry)               │
└──────────────────┬──────────────────────┘
                   │
                   v
┌─────────────────────────────────────────┐
│          app.rs (GUI Layer)             │
│  - Makepad GUI界面                       │
│  - 用户交互处理                          │
│  - 文件选择对话框                        │
│  - 状态管理                              │
└──────────────────┬──────────────────────┘
                   │
                   v
┌─────────────────────────────────────────┐
│      patcher.rs (Business Logic)        │
│  - YAML解析和序列化                      │
│  - 代理字符串解析                        │
│  - 代理链生成                            │
│  - 配置验证                              │
└─────────────────────────────────────────┘
```

### 数据流

```
用户输入 → GUI → Patcher → YAML处理 → 输出文件
  ↑                                         ↓
  └─────────── 预览/错误信息 ←──────────────┘
```

## 跨平台支持

### Windows
- **发布格式**:
  - NSIS安装包 (推荐)
  - 便携版ZIP (包含Makepad资源)
- **构建输出**: `target/release/clash-chain-patcher.exe`
- **特殊处理**:
  - 使用 `#![windows_subsystem = "windows"]` 隐藏控制台
  - 通过 `build.rs` 嵌入图标资源

### macOS
- **发布格式**:
  - DMG镜像
  - ZIP包 (含.app bundle)
- **构建输出**: `dist/Clash Chain Patcher.app`
- **首次启动**: 需要运行 `xattr -cr` 移除隔离属性

### Linux
- **发布格式**:
  - DEB包
  - 原生二进制
- **构建输出**: `target/release/clash-chain-patcher`
- **依赖**: X11/Wayland, GTK3, ALSA/PulseAudio

## CI/CD流程

### 发布触发
- 推送tag (格式: `v*`)
- 手动触发 (workflow_dispatch)

### 构建流程
1. **并行构建**: Windows, macOS, Linux
2. **打包**: 使用 cargo-packager
3. **资源处理**: 自动复制Makepad资源
4. **发布**: 上传到GitHub Releases

### 构建缓存
- Cargo依赖缓存 (基于Cargo.lock)
- 加速后续构建

## 参考资源

### 官方文档
- [Makepad官方文档](https://book.makepad.rs/)
- [Makepad GitHub](https://github.com/makepad/makepad)
- [cargo-packager文档](https://github.com/crabnebula-dev/cargo-packager)

### 相关项目
- [Robrix](https://github.com/project-robius/robrix) - Makepad示例应用
- [Clash](https://github.com/Dreamacro/clash) - Clash代理核心

## 已知限制

1. **Makepad框架限制**:
   - Windows标题栏显示问题 (已通过隐藏内置标题栏解决)
   - 中文字体资源打包需要自定义命令

2. **打包限制**:
   - Windows独立exe需要bundled资源
   - macOS需要手动移除隔离属性
   - Linux依赖较多系统库

3. **功能限制**:
   - 当前仅支持静态配置修改
   - 不支持配置验证
   - 不支持批量处理

## 未来规划

参见 [roadmap.md](roadmap.md)
