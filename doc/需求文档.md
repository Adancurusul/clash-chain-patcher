# 需求文档

## 项目目标

开发一个跨平台工具,支持两种工作模式为Clash用户提供代理链功能:
1. **静态模式**: 修改Clash YAML配置文件,添加SOCKS5代理链
2. **动态模式**: 提供本地SOCKS5代理服务器,实时转发流量到上游SOCKS5

## 用户场景

### 场景1: 静态配置修改 (已实现)

**用户故事**:
作为Clash用户,我希望在所有现有代理节点前添加一个固定IP的SOCKS5代理,这样所有流量都会先经过这个固定IP。

**使用流程**:
1. 选择Clash配置文件
2. 输入SOCKS5代理信息
3. (可选) 设置关键词过滤
4. 预览将要生成的代理链
5. 应用修改并保存新配置
6. 在Clash中加载新配置

### 场景2: 动态代理服务 + 自动配置管理 (开发中)

**用户故事**:
作为用户,我希望运行一个本地SOCKS5服务器,自动将所有流量转发到上游SOCKS5代理。同时,程序能自动监控Clash配置文件变化,在订阅更新后自动合并我的本地代理节点,这样我不需要每次手动修改配置。

**使用流程**:
1. 在GUI中配置上游SOCKS5代理列表
2. 配置Clash配置文件路径
3. 启用自动监控功能
4. 启动本地SOCKS5服务器
5. 程序自动检测Clash订阅更新并合并配置
6. 实时查看连接状态和流量统计
7. 根据需要切换/添加上游代理

## 功能需求

### 阶段1: 静态配置修改 (已完成 v0.1.2)

#### F1.1 文件选择
- 支持选择YAML格式的Clash配置文件
- 显示当前选择的文件路径

#### F1.2 SOCKS5代理配置
- 支持手动输入: Host, Port, Username, Password
- 支持两种格式的快速填充:
  - 格式1: `user:pass@host:port`
  - 格式2: `host:port:user:pass`
- 支持协议前缀: `socks5://`, `http://`, `https://`

#### F1.3 代理过滤
- 支持关键词过滤(逗号分隔)
- 内置跳过规则: "若节点超时", "Emby", "SOCKS5"

#### F1.4 预览功能
- 显示将要创建的代理链名称列表
- 显示影响的节点数量
- 显示SOCKS5配置摘要

#### F1.5 应用和保存
- 生成修改后的配置
- 保存为新文件
- 显示操作日志

### 阶段2: 动态代理服务 + 自动配置管理 (开发中)

#### F2.1 本地SOCKS5服务器 (已完成 - Task 1.x)
- ✅ 监听本地端口 (默认: 10808, 可配置)
- ✅ 支持SOCKS5协议完整实现
- ✅ 支持TCP连接转发
- ✅ 单上游代理转发
- ⏳ (可选) 支持UDP转发

#### F2.2 上游代理管理 (待开发 - Task 2.1)
- 支持添加/删除/编辑上游SOCKS5代理
- 支持多个上游代理列表
- 在GUI中显示代理列表
- 支持启用/禁用单个代理
- 配置持久化到文件

#### F2.3 健康检查 (待开发 - Task 2.2)
- 定期检查上游代理可用性 (默认5分钟)
- 测试连接延迟
- 显示每个代理的健康状态 (✅ 健康 / ⚠️ 不健康 / ⚫ 未知)
- 显示最后检查时间
- 支持手动触发检查

#### F2.4 Clash配置文件监控 (待开发 - Task 2.3)
- 监控Clash配置文件变化
- 检测订阅更新
- 自动合并Local-Chain-Proxy节点到配置
- 自动添加到所有select类型代理组
- 自动备份原配置
- 显示监控状态和最后更新时间

#### F2.5 自动故障切换 (待开发 - Task 2.4)
- 检测到上游不可用时自动切换
- 支持配置故障切换策略:
  - 轮询 (Round Robin)
  - 随机 (Random)
  - 优先级 (Priority)
  - 最低延迟 (Lowest Latency)
- 恢复后可选择自动切回

#### F2.6 连接监控 (待开发 - Task 2.5)
- 实时显示当前连接数
- 显示活跃连接列表
- 显示流量统计 (上传/下载)
- 支持连接日志记录

#### F2.7 GUI集成 (待开发 - Task 2.6)
- Tab切换: "配置修改" vs "代理服务"
- 上游代理管理界面
- 健康状态显示面板
- Clash配置监控界面
- 服务控制: 启动/停止按钮
- 状态显示: 运行状态, 端口, 当前上游
- 日志面板: 显示连接日志

#### F2.8 Clash API集成 (可选 - Task 2.7)
- 配置Clash API地址和密钥
- 自动重载Clash配置
- 自动切换节点到Local-Chain-Proxy
- 显示Clash运行状态

## 非功能需求

### NFR1: 性能
- 本地服务器延迟: < 5ms (p99)
- 支持并发连接: > 1000
- 内存占用: < 100MB (空闲时)

### NFR2: 可靠性
- 服务器稳定运行: > 99.9% uptime
- 故障切换时间: < 3s
- 配置修改成功率: 100%

### NFR3: 易用性
- 启动时间: < 3s
- GUI响应时间: < 100ms
- 一键启动/停止服务

### NFR4: 安全性
- 本地服务器仅监听 127.0.0.1
- 敏感信息(密码)不记录到日志
- 配置文件权限检查

### NFR5: 兼容性
- 支持Clash各版本YAML格式
- 支持标准SOCKS5协议
- 跨平台: Windows 10+, macOS 10.15+, Linux (X11/Wayland)

## 技术约束

### TC1: 技术栈
- 编程语言: Rust
- GUI框架: Makepad
- 异步运行时: Tokio

### TC2: 依赖限制
- 尽量使用纯Rust实现
- 避免过多外部依赖
- 优先选择维护活跃的库

### TC3: 打包要求
- 单一可执行文件 (Windows便携版为ZIP)
- 自包含所有资源
- 支持自动更新 (未来)

## 验收标准

### 阶段1验收 (已完成)
- [ ] 成功加载和解析Clash YAML配置
- [ ] 正确生成代理链配置
- [ ] 两种代理字符串格式均可解析
- [ ] 关键词过滤正常工作
- [ ] 生成的配置可被Clash正常加载
- [ ] 跨平台构建和运行正常

### 阶段2验收 (待开发)
- [ ] 本地SOCKS5服务器可正常启动
- [ ] Clash可通过本地服务器连接
- [ ] 上游代理切换正常工作
- [ ] 健康检查准确识别不可用代理
- [ ] 故障切换在3秒内完成
- [ ] GUI实时更新连接状态
- [ ] 日志完整记录关键操作

## 里程碑

### M1: v0.1.0 - MVP (已完成)
- 基础GUI
- YAML配置修改
- 代理链生成

### M2: v0.1.2 - 稳定版 (当前)
- 修复Windows兼容性问题
- 完善CI/CD流程
- 添加README和文档

### M3: v0.2.0 - 动态代理核心 (开发中)
**目标**: 实现核心代理服务器功能
- ✅ 实现本地SOCKS5服务器 (Task 1.1-1.6)
- ✅ 支持单上游代理转发
- ⏳ 上游代理管理数据结构 (Task 2.1)
- ⏳ 健康检查器 (Task 2.2)
- ⏳ 配置文件监控 (Task 2.3)
- ⏳ 配置自动合并 (Task 2.4)

### M4: v0.3.0 - GUI集成和自动化 (规划中)
**目标**: GUI界面和自动化功能
- GUI上游代理管理界面
- GUI健康状态显示
- GUI Clash配置监控界面
- 主界面整合
- (可选) Clash API自动化

### M5: v0.4.0 - 高级功能 (规划中)
**目标**: 高级功能和优化
- 多上游自动选择
- 自动故障切换
- 连接监控和统计
- 系统托盘集成

### M6: v1.0.0 - 生产就绪 (规划中)
**目标**: 稳定性和完整性
- 性能优化
- 完整测试覆盖
- 用户文档完善
- 自动更新支持
- 多语言支持

## 风险和假设

### 风险
1. Makepad框架相对新,可能存在未知问题
2. SOCKS5协议实现的复杂性可能导致兼容性问题
3. 跨平台打包可能遇到资源路径问题

### 假设
1. 用户已安装Clash并理解其基本概念
2. 用户有合法的上游SOCKS5代理访问权限
3. 用户系统允许运行本地网络服务
